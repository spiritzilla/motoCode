/*
 * searchselect.js - Search Selector UI behaviors
 * Copyright ?? 2011 by Ingenesis Limited. All rights reserved.
 * Licensed under the GPLv3 {@see license.txt}
 */
function SearchSelector(b){var e=jqnc(),a=this,g=e(this),c,f={source:"shopp_tags",parent:"",url:ajaxurl,action:"shopp_suggestions",fieldname:"input[]",label:"Begin typing to search&hellip;",classname:"",freeform:false,autosuggest:false,autodelay:3000},b=e.extend(f,b),d=e('<ul class="search-select"><li><input type="text" name="entry" class="input" /></li></ul>'),h=d.find("input.input").focus(function(){d.find("li.selected").removeClass("selected");e(document).unbind("keydown").keydown(a.keyhandler)});a.ui=d;a.stopEvent=function(i){if(i.preventDefault){i.preventDefault()}if(i.stopPropagation){i.stopPropagation()}i.cancelBubble=true;i.returnValue=false};a.keyhandler=function(l){var k=h.val();if(!(/8$|9$|13$|46$|37$|39$/.test(l.keyCode))){return}var i=d.find("li.item.selected"),j;if(e(l.target).hasClass("input")){j=h.parent().prev();switch(l.keyCode){case 9:case 13:a.stopEvent(l);if(b.freeform&&k.length>0){d.append(a.newItem("",k));h.val("").parent().appendTo(d);h.focus()}break;case 188:if(b.freeform&&k.length>0){a.stopEvent(l);d.append(a.newItem("",k));h.val("").parent().appendTo(d);h.focus()}case 37:case 8:case 46:if(h.val().length>0){break}a.stopEvent(l);if(!j.length){break}h.blur();j.click();break}return}if(i.length){a.stopEvent(l);switch(l.keyCode){case 8:case 46:i.fadeRemove("fast",function(){h.focus()});break;case 37:i.prev("li.item").click();break;case 39:i.next("li").click();break}}};a.newItem=function(k,i){var j=e('<li class="item"><input type="hidden" name="'+b.fieldname+"["+k+']" value="'+i+'" />'+i+'<a href="#" class="remove"></a></li>').hoverClass().click(function(l){if(l.preventDefault){l.preventDefault()}if(l.stopPropagation){l.stopPropagation()}l.cancelBubble=true;l.returnValue=false;j.parent().find("li.item.selected").removeClass("selected");e(this).addClass("selected");e(document).unbind("keydown").keydown(a.keyhandler)});j.find("a.remove").click(function(){j.fadeRemove("fast")});return j};a.selection=function(){var m=e(this),k=m.val(),j=m.attr("alt"),i=m.parent(),l=i.parent();l.append(a.newItem(j,k));i.appendTo(l);m.val("").attr("alt","").focus()};d.appendTo(b.parent).click(function(){h.focus()}).suggest(b.url+"&action="+b.action+"&s="+b.source,{delay:300,minchars:2,format:"json",showOnFocus:true,autoSelect:true,autoDelay:b.autodelay,autoSuggest:b.autosuggest,label:b.label,resultsClass:"search-select-results"+(b.classname?" "+b.classname:""),onSelect:this.selection});return this};