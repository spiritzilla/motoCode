/*
 * checkout.js - Shopp catalog behaviors library
 * Copyright ?? 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(){var d=jqnc(),m=false,e=d(".sameaddress"),c=d("#submit-login-checkout"),n=d("#account-login-checkout"),j=d("#password-login-checkout"),l=d("#guest-checkout"),k=d("#checkout.shopp"),s=d("#shipping-address-fields"),o=d("#billing-address-fields"),r=d("#checkout.shopp [name=paymethod]"),a=d("#billing-locale"),t=d("#billing-card"),p=d("#billing-cardtype"),v=d(".payoption-button"),b=d(".payoption-"+d_pm),q=d("#shopp-checkout-function"),h=d("#checkout.shopp li.locale");if(k.find("input[name=checkout]").val()=="process"){v.hide();if(b.length==0){b=d(".payoption-0")}b.show();r.change(g).change()}k.bind("shopp_validate",function(){if(!f()){this.shopp_validation=["Not a valid card number.",t.get(0)]}});t.change(f);p.change(function(){var x=new String(p.val()).toLowerCase(),w=paycards[x];d(".paycard.xcsc").attr("disabled",true).addClass("disabled");if(!w||!w.inputs){return}d.each(w.inputs,function(y,z){d("#billing-xcsc-"+y).attr("disabled",false).removeClass("disabled")})}).change();if(a.children().size()==0){h.hide()}c.click(function(w){k.unbind("submit.validate").bind("submit.validlogin",function(y){var x=false;if(""==j.val()){x=[$co.loginpwd,j]}if(""==n.val()){x=[$co.loginname,n]}if(x){y.preventDefault();k.unbind("submit.validlogin").bind("submit.validate",function(z){return validate(this)});alert(x[0]);x[1].focus().addClass("error");return false}q.val("login")})});d("#billing-country, .billing-state, #shipping-country, .shipping-state").bind("change.localemenu",function(z,C){var B=e.is(":checked")?e.val():false,A="shipping"==B?d("#billing-country").val():d("#shipping-country").val(),y="shipping"==B?d('.billing-state[disabled!="true"]').val():d('.shipping-state[disabled!="true"]').val(),D=A+y,x,w;if(C||!a.get(0)||(!B&&(d(this).is("#billing-country")||d(this).is(".billing-state")))){return}a.empty().attr("disabled",true);if(locales&&(w=locales[D])||(w=locales[A])){x+="<option></option>";d.each(w,function(F,E){x+='<option value="'+E+'">'+E+"</option>"});d(x).appendTo(a);a.removeAttr("disabled");h.show()}});d("#firstname,#lastname").change(function(){d("#billing-name,#shipping-name").val(new String(d("#firstname").val()+" "+d("#lastname").val()).trim())});e.change(function(A,C){var x=false,z=d("#billing-country"),B=d("#shipping-country"),w="billing"==e.val()?s:o,y="shipping"==e.val()?s:o;if(e.is(":checked")){w.removeClass("half");y.hide().find(".required").setDisabled(true)}else{w.addClass("half");y.show().find(".disabled:not(._important)").setDisabled(false);if(!C){x=true}}if(z.is(":visible")){z.trigger("change.localemenu",[C])}if(B.is(":visible")){B.trigger("change.localemenu",[C])}if(x){y.find("input:first").focus()}}).trigger("change",[true]).click(function(){d(this).change()});l.change(function(w){var x=k.find("input.passwords"),y=[];d.each(x,function(){y.push("label[for="+d(this).attr("id")+"]")});y=k.find(y.join(","));if(l.is(":checked")){x.setDisabled(true).hide();y.hide()}else{x.setDisabled(false).show();y.show()}}).trigger("change");d(".shopp .shipmethod").change(function(){if("process"==d("#checkout #shopp-checkout-function").val()){var A=".shopp-cart.cart-",z="span"+A,x="input"+A,w=["shipping","tax","total"],y=[];d.each(w,function(C,B){y.push(z+B)});if(!c_upd){c_upd="?"}d(y.join(",")).html(c_upd);d.getJSON($co.ajaxurl+"?action=shopp_ship_costs&method="+d(this).val(),function(B){d.each(w,function(D,C){d(z+C).html(asMoney(new Number(B[C])));d(x+C).val(new Number(B[C]))})})}else{d(this).parents("form").submit()}});d(window).load(function(){d(document).trigger("shopp_paymethod",[r.val()])});function g(B){var A=d(this),z=d(this).val(),w=d(".payoption-"+z),y="",x=false;if(this!=window&&A.attr&&"radio"==A.attr("type")&&!A.is(":checked")){return}d(document).trigger("shopp_paymethod",[z]);v.hide();if(w.length==0){w=d(".payoption-0")}if(pm_cards[z]&&pm_cards[z].length>0){k.find(".payment,.paycard").show();k.find(".paycard.disabled").attr("disabled",false).removeClass("disabled");if(typeof(paycards)!=="undefined"){d.each(pm_cards[z],function(C,D){if(!paycards[D]){return}x=paycards[D];y+='<option value="'+x.symbol+'">'+x.name+"</option>"});p.html(y).change()}}else{k.find(".payment,.paycard").hide();k.find(".paycard").attr("disabled",true).addClass("disabled")}w.show()}function f(){if(t.length==0){return true}if(t.attr("disabled")){return true}var w=t.val().replace(/\D/g,""),y=r.filter(":checked").val()?r.filter(":checked").val():r.val(),x=false;if(!y){y=d_pm}if(t.val().match(/(X)+\d{4}/)){return true}if(!pm_cards[y]){return true}d.each(pm_cards[y],function(z,B){var A=paycards[B],C=new RegExp(A.pattern.substr(1,A.pattern.length-2));if(w.match(C)){x=A.symbol;return p.val(x).change()}});if(!u(w)){return false}return x}function u(x){x=x.toString().replace(/\D/g,"").split("").reverse();if(!x.length){return false}var w=0;for(i=0;i<x.length;i++){x[i]=parseInt(x[i],10);w+=i%2?2*x[i]-(x[i]>4?9:0):x[i]}return(w%10)==0}});if(!locales){var locales=false};