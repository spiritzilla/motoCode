/*
 * shiprates.js - Shipping rates UI behaviors
 * Copyright ?? 2011 by Ingenesis Limited. All rights reserved.
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(g){if(g("#flatrates-editor").size()>0){g.each(shipping,function(j,i){g.template(i+"-editor",g("#"+i+"-editor"))});g.template("delivery-menu",g("#delivery-menu"));g.template("flatrates-editor",g("#flatrates-editor"));g.template("flatrate-row",g("#flatrate-row"));g.template("tablerates-editor",g("#tablerates-editor"));g.template("tablerate-row",g("#tablerate-row"));g.template("tablerate-row-tier",g("#tablerate-row-tier"));g.template("location-fields",g("#location-fields"))}var a=false,h=g("#shipping-option-menu"),f=g("#no-shiprate-settings"),d=function(l){if(!l.postcode){l.postcode="*"}var j=this,m=g.tmpl("location-fields",l),n=m.find("select"),i=m.find("input.postcode"),k=function(q,p){return'<option value="'+q+'">'+p+"</option>"},o=function(v,A){var z=n.val().split(","),w="",y=[],u=[],s=" &#x25be;",p="&sdot;&sdot;&sdot;&nbsp;",q={region:"*",country:"",area:"",zone:""},t=0,x=false;if(A){z=A.split(",")}for(key in q){if(z[t]){q[key]=z[t]}t++}for(t in lookup.regions){if(t==q.region&&lookup.regionmap[t]){w+=k(t,lookup.regions[t]+s);u=lookup.regionmap[t];for(r in u){country=u[r];countryname=lookup.countries[country];if(country==q.country){x=(lookup.postcodes[country]);if(lookup.areas[country]){w+=k(t+","+country,countryname+s);areas=lookup.areas[country];for(area in areas){if(area==q.area){zones=lookup.areas[country][area];w+=k(t+","+country+","+area,area+s);w+='<optgroup label="'+area+'">';for(zoneid in zones){zone=zones[zoneid];w+=k(t+","+country+","+area+","+zone,lookup.zones[country][zone]+", "+country.substr(0,2))}w+="</optgroup>"}else{w+=k(t+","+country+","+area,"&nbsp;&nbsp;"+area)}}}else{if(lookup.zones[country]){w+=k(t+","+country,countryname+s);w+='<optgroup label="'+countryname+'">';zones=lookup.zones[country];for(zone in zones){w+=k(t+","+country+","+zone,zones[zone]+", "+country.substr(0,2))}w+="</optgroup>"}else{w+=k(t+","+country,countryname)}}}else{w+=k(t+","+country,p+countryname)}}}else{w+=k(t,lookup.regions[t])}}for(key in q){if(q[key]!=""){y.push(q[key])}}n.empty().html(w).val(y.join(","));if(x){i.attr("disabled",false)}};n.change(o);o(false,l.destination);return m},c=function(n,k){if(!(n&&k)){return}var m=[],l=[],i=false,j=n.parents("table.shopp-settings").find("button.addrate");if(k.table){l=k.table}if(k.module){i=k.module}if(k.norates){n.find("th.rate").remove()}n.row=function(s,q){if(s){s.preventDefault()}if(!q){q={}}q.module=i;q.row=(m.length);var u=g.tmpl("flatrate-row",q),o=u.find("input.money").each(function(){this.value=asMoney(new Number(this.value))}).change(function(){this.value=asMoney(this.value)}).mouseup(function(){g(this).select()}),t=new d(q),p=u.find("button.delete").click(function(v){v.preventDefault();u.fadeRemove()});if(k.norates){u.find("td.rate").remove()}m.push(u);if(m.length>1){u.hover(function(){p.fadeIn("fast")},function(){p.hide()})}t.prependTo(u);u.appendTo(n.find("tbody"))};j.click(n.row);if(l.length==0){n.row(false)}else{g.each(l,function(o,p){n.row(false,p)})}},e=function(n,k){if(!(n&&k)){return}var m=[],l=[],i=false,j=n.parents("table.shopp-settings").find("button.addrate");if(k.table){l=k.table}if(k.module){i=k.module}n.row=function(u,p,s){var w=[];if(u){u.preventDefault()}if(!s){s={}}s.module=i;s.row=(!p?m.length:p);if(k.unit){s.unit=k.unit[0]?k.unit[0]:"?";s.unitabbr=k.unit[1]?k.unit[1]:$s.c}else{s.unit="?";s.unitabbr="?"}var x=g.tmpl("tablerate-row",s),q=s.row,o=x.find("table.panel"),t=new d(s),v=x.find("button.delete").click(function(y){y.preventDefault();x.fadeRemove()});t.insertBefore(x.find("td:first"));m.push(x);if(m.length>1){x.hover(function(){v.fadeIn("fast")},function(){v.hide()})}x.addtier=function(D,B){if(D){D.preventDefault()}if(!B){B={threshold:1,rate:1}}B.module=i;B.row=q;B.tier=w.length;B.unitabbr="";B.threshold_class=k.threshold_class;B.rate_class=k.rate_class;if(k.unit&&k.unit[1]){B.unitabbr=k.unit[1]}var y=g.tmpl("tablerate-row-tier",B),C=y.find("input").mouseup(function(){g(this).select()}),A=y.find("button.add").click(x.addtier),z=y.find("button.delete").click(function(E){E.preventDefault();y.fadeRemove()});debuglog(B);y.find("input.money").each(function(){this.value=asMoney(this.value.match(/[^(\d,\. )]/)?asNumber(this.value):new Number(this.value))}).change(function(){this.value=asMoney(this.value)});y.find("input.percentage").each(function(){this.value=asPercent(this.value.match(/[^(\d,\. )]/)?asNumber(this.value):new Number(this.value))}).change(function(){this.value=asPercent(this.value)}).change();w.push(y);if(w.length>1){y.hover(function(){z.fadeIn("fast")},function(){z.hide()})}else{z.css("opacity",0).removeClass("hidden").unbind("click").click(function(E){E.preventDefault()})}y.appendTo(o)};if(!s.tiers){x.addtier()}else{g.each(s.tiers,function(z,y){x.addtier(false,y)})}x.appendTo(n)};j.click(n.row);if(l.length==0){n.row(false,0)}else{g.each(l,function(p,o){n.row(false,p,o)})}},b=function(q){var n=false;q.preventDefault();if(a){a.cancel(false)}f.hide();var s=g(this),y=g.getQueryVar("id",s.attr("href")),m=h.val()?h.val().toLowerCase():y,o=settings[m]?settings[m]:(defaults[m]?defaults[m]:{}),x=s.parents("tr").hide(),j=x.size()>0?x.attr("id").substr(17):false,i=o.type?o.type:(j?j:m),t=g.tmpl(i+"-editor",o),w=t.find("a.cancel"),l=t.find("input.fallback").attr("checked","on"==o.fallback?"checked":false),p=t.find("select.maxdelivery").html(g.tmpl("delivery-menu")).val(o.maxdelivery),u=t.find("select.mindelivery").html(g.tmpl("delivery-menu")).val(o.mindelivery).change(function(){var B=g(this),A=B.attr("selectedIndex"),z=p.attr("selectedIndex");p.find("option").attr("disabled",false).each(function(C,D){if(C<A){g(D).attr("disabled","disabled")}});if(z<A){p.attr("selectedIndex",A)}}),k=t.find("input.selectall-toggle").change(function(B){var A=g(this),z=A.parents("ul").find("input");z.attr("checked",A.attr("checked"))}),v=(t.find("table.rate-table-shipping").size()>0);if(x.size()==0){x=g("#shipping-setting-"+i).hide()}h.get(0).selectedIndex=0;s.cancel=function(z){if(z){z.preventDefault()}a=false;t.remove();x.fadeIn("fast");if(f.size()>0){f.show()}};w.click(s.cancel);if(v){n=t.find("table.flatrates");if(n.size()>0){c(n,o)}n=t.find("table.tablerates");if(n.size()>0){e(n,o)}}if(x.size()>0){t.insertAfter(x)}else{t.prependTo("#shiprates")}a=s};g("#shipping a.edit").click(b);h.change(b);g("#shipping a.delete").click(function(){if(confirm($ps.confirm)){return true}else{return false}})});