/*
 * taxrates.js - Tax rate editor behaviors
 * Copyright ?? 2008-2011 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
jQuery(document).ready(function(c){c.template("editor",c("#editor"));c.template("conditional",c("#conditional"));c.template("localrate",c("#localrate"));c.template("property-menu",c("#property-menu"));c.template("countries-menu",c("#countries-menu"));var a=false,b=c("#no-taxrates");c("#taxrates a.edit, #addrate").click(function(z){if(z){z.preventDefault()}b.hide();var l=c(this),p=rates.length,h=0,k=l.parents("tr").hide(),v=c.getQueryVar("id",l.attr("href")),A=rates[v]?rates[v]:{},D=c.extend({id:v?v:p++,rate:0,country:false,zone:false,logic:"any",rules:[]},A),u=c.tmpl("editor",D),y=u.find("div.conditionals").hide().removeClass("no-conditions"),q=y.find("ul"),j=u.find("select.logic").val(D.logic),B=u.find("select.country"),g=u.find("select.zone").hide().removeClass("no-zones"),x=u.find(".local-rates").hide().removeClass("no-local-rates"),w=x.find("ul"),s=u.find(".has-locals"),m=u.find(".add-locals").hide().removeClass("has-local-rates"),o=u.find(".rm-locals").hide().removeClass("no-local-rates"),C=u.find("button.upload"),t=C.parent(),f=u.find("p.instructions"),i=u.find("a.cancel"),n=u.find("#tax-rate").change(function(){this.value=asPercent(this.value,false,4)}).change(),d=u.find("button.add");l.rules=[];B.html(c.tmpl("countries-menu")).val(D.country).change(function(H){var G=c(this),F="",E=zones[G.val()]?zones[G.val()]:false;if(E!=false){F+='<option value=""></option>';c.each(E,function(I,e){F+='<option value="'+I+'">'+e+"</option>"});g.html(F).val(D.zone).show()}else{g.empty().hide()}}).change();l.cancel=function(E){if(E){E.preventDefault()}a=false;u.remove();k.fadeIn("fast");if(b.size()>0){b.show()}};i.click(l.cancel);l.addlocals=function(E){if(E){E.preventDefault()}m.hide();o.show();s.val("true");x.hide().removeClass("no-local-rates").show()};m.click(l.addlocals);l.rmlocals=function(E){if(E){E.preventDefault()}o.hide();m.show();s.val("false");x.fadeOut("fast")};o.click(l.rmlocals);C.upload({name:"ratefile",action:ajaxurl,params:{action:"shopp_upload_local_taxes",_wpnonce:c("#_wpnonce").val()},accept:"text/plain,text/xml",maxfilesize:"1048576",onSubmit:function(){w.empty();f.empty().removeClass("error");C.attr("disabled",true).addClass("updating").parent().css("width","100%")},onComplete:function(E){C.removeAttr("disabled").removeClass("updating");try{r=c.parseJSON(E);if(r.error){f.addClass("error").html(r.error)}else{l.addlocals(r)}}catch(e){alert("LOCAL_RATES_UPLOADERR")}}});l.addlocalrate=function(e,E){var F={id:D.id,localename:e,localerate:asNumber(E)};c.tmpl("localrate",F).appendTo(w)};l.addlocals=function(e){c.each(e,function(E,F){l.addlocalrate(E,F)});f.empty()};if(D.haslocals){if(D.locals!=undefined){l.addlocals(D.locals)}x.show();o.show()}else{m.show()}l.addrule=function(J,H,I){if(J){J.preventDefault()}if(!H){H=h}if(!I){I={}}I.id=D.id;I.ruleid=H;I.rulevalue=I.v;var E=c.tmpl("conditional",I).appendTo(q),F=E.find("input.value"),G=E.find("select.property").html(c.tmpl("property-menu")).val(I.p).change(function(){F.unbind("keydown").unbind("keypress").suggest(suggurl+"&action=shopp_suggestions&t="+c(this).val(),{delay:500,minchars:2,format:"json"})}).change(),K=E.find("button.delete").click(function(L){if(L){L.preventDefault()}E.remove();l.rules.pop();if(l.rules.length==0){y.hide()}}).hide();addrulebtn=E.find("button.add").click(l.addrule);E.hover(function(){K.show()},function(){K.fadeOut("fast")});y.show();h++;l.rules.push(h)};d.click(l.addrule);if(D.rules.length>0){c.each(D.rules,function(e,E){l.addrule(false,e,E)})}if(k.size()>0){u.insertAfter(k)}else{u.prependTo("#taxrates-table")}quickSelects();a=l})});